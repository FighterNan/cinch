#------------------------------------------------------------------------------#
# Copyright (c) 2014 Los Alamos National Security, LLC
# All rights reserved.
#------------------------------------------------------------------------------#

################################################################################
# Please Do Not Edit This File Unless You Know What You Are Doing!!!
#
# Project-specific configuration rules should be added in the 'config'
# subdirectory of the top-level of this project in the appropriate file,
# e.g., package configuration options should go in 'config/packages.cmake'.
#
# For more documentation on the design philosophy of this build system
# and the recognized configuration files that can be added to the 'config'
# subdirectory, please look in 'cinch/README.md' and 'cinch/INSTALL.md'
# from the top-level of this project.
#
# Any changes to the basic build template should be discussed with the
# project maintainers.
################################################################################

#------------------------------------------------------------------------------#
# Require some version of cmake
#------------------------------------------------------------------------------#

cmake_minimum_required(VERSION 2.8)

#------------------------------------------------------------------------------#
# Add path for cinch modules
#------------------------------------------------------------------------------#

list(APPEND CMAKE_MODULE_PATH ${CMAKE_SOURCE_DIR}/cinch/cmake)

#------------------------------------------------------------------------------#
# Cinch includes
#------------------------------------------------------------------------------#

include(info)
include(common)
include(include_links)
include(insource)
include(subdirlist)
include(unit)
include(documentation)
include(library)
include(application)
include(subproject)
include(doxygen)
include(version)

#------------------------------------------------------------------------------#
# Print useful information
#------------------------------------------------------------------------------#

if(CMAKE_INSTALL_PREFIX)
    message(STATUS "Install prefix set to ${CMAKE_INSTALL_PREFIX}")
endif(CMAKE_INSTALL_PREFIX)

if(CMAKE_CXX_FLAGS)
    message(STATUS "C++ compiler flags set to ${CMAKE_CXX_FLAGS}")
endif(CMAKE_CXX_FLAGS)

if(CMAKE_C_FLAGS)
    message(STATUS "C compiler flags set to ${CMAKE_C_FLAGS}")
endif(CMAKE_C_FLAGS)

if(CMAKE_FORTRAN_FLAGS)
    message(STATUS "Fortran compiler flags set to ${CMAKE_FORTRAN_FLAGS}")
endif(CMAKE_FORTRAN_FLAGS)

#------------------------------------------------------------------------------#
# Include project configuration
#------------------------------------------------------------------------------#

# Initialize these to avoid capture of parent state
unset(CINCH_APPLICATION_DIRECTORIES)
unset(CINCH_LIBRARY_TARGETS)
unset(CINCH_SUBPROJECTS)

include(${CMAKE_CURRENT_SOURCE_DIR}/config/project.cmake)

#------------------------------------------------------------------------------#
# Create a version for the project
#------------------------------------------------------------------------------#

set(VERSION_CREATION "git describe" CACHE STRING "Set a static version")

if(NOT ${VERSION_CREATION} STREQUAL "git describe")
    set(${PROJECT_NAME}_VERSION ${VERSION_CREATION})
else()
    cinch_make_version()
endif(NOT ${VERSION_CREATION} STREQUAL "git describe")

message(STATUS "Creating build for version "
    "${PROJECT_NAME}-${${PROJECT_NAME}_VERSION}")

#------------------------------------------------------------------------------#
# Keep users from creating insource builds.
#------------------------------------------------------------------------------#

cinch_prevent_insource_builds()

#------------------------------------------------------------------------------#
# Include package requirements
#------------------------------------------------------------------------------#

include(${CMAKE_CURRENT_SOURCE_DIR}/config/packages.cmake)

#------------------------------------------------------------------------------#
# Include project documentation
#------------------------------------------------------------------------------#

include(${CMAKE_CURRENT_SOURCE_DIR}/config/documentation.cmake)

#------------------------------------------------------------------------------#
# Add top-level targets
#------------------------------------------------------------------------------#

if(${CMAKE_SOURCE_DIR} STREQUAL ${CMAKE_CURRENT_SOURCE_DIR})

    #--------------------------------------------------------------------------#
    # This is a top-level build
    #--------------------------------------------------------------------------#

    add_custom_target(distclean rm -rf ${CMAKE_BINARY_DIR}/*)
    set(CINCH_CONFIG_INFOTAG)

    #--------------------------------------------------------------------------#
    # Remove include links
    #--------------------------------------------------------------------------#

    if(EXISTS ${CMAKE_BINARY_DIR}/include)
        file(REMOVE_RECURSE ${CMAKE_BINARY_DIR}/include)
    endif(EXISTS ${CMAKE_BINARY_DIR}/include)

    #--------------------------------------------------------------------------#
    # Add support for ctest and GTest
    #--------------------------------------------------------------------------#

    option(ENABLE_UNIT_TESTS "Enable unit testing" OFF)
    option(ENABLE_JENKINS_OUTPUT
        "Generate jenkins xml output for every test" OFF)

    if(ENABLE_UNIT_TESTS)
        enable_testing()
        find_package(GTest QUIET)
        if(GTEST_FOUND)
          include_directories(${GTEST_INCLUDE_DIRS})
        else()
          add_subdirectory(cinch/gtest)
          include_directories(cinch/gtest/include)
          set(GTEST_BOTH_LIBRARIES gtest gtest_main)
        endif()
    endif(ENABLE_UNIT_TESTS)

else()

    #--------------------------------------------------------------------------#
    # This is a submodule
    #--------------------------------------------------------------------------#

    set(CINCH_CONFIG_INFOTAG "${PROJECT_NAME}.")

endif(${CMAKE_SOURCE_DIR} STREQUAL ${CMAKE_CURRENT_SOURCE_DIR})

#------------------------------------------------------------------------------#
# Add support for Doxygen documentation
#
# NOTE: This depends on CINCH_CONFIG_INFOTAG being set.
#------------------------------------------------------------------------------#

cinch_add_doxygen()

#------------------------------------------------------------------------------#
# Set output directories for targets
#------------------------------------------------------------------------------#

# Global project settings
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

#------------------------------------------------------------------------------#
# Add local include subdirectory.
#
# This is populated by calls to cinch_make_include_links below.
#------------------------------------------------------------------------------#

include_directories(${CMAKE_BINARY_DIR}/include)

#------------------------------------------------------------------------------#
# Add sub-projects
#------------------------------------------------------------------------------#

if(CINCH_SUBPROJECTS)
    foreach(subproject ${CINCH_SUBPROJECTS})
        string(REPLACE ":" ";" subproject_data ${subproject})

        list(GET subproject_data 0 subproject_name)

        # This value is currently unused
        #list(GET subproject_data 1 subproject_libraries)

        add_subdirectory(${subproject_name})

    endforeach(subproject)
endif(CINCH_SUBPROJECTS)

#------------------------------------------------------------------------------#
# Library target
#------------------------------------------------------------------------------#

if(CINCH_LIBRARY_TARGETS)

    #--------------------------------------------------------------------------#
    # Process library targets
    #--------------------------------------------------------------------------#

    foreach(library_target ${CINCH_LIBRARY_TARGETS})

        string(REPLACE ":" ";" library_target_list ${library_target})

        list(GET library_target_list 0 library_target_name)
        list(GET library_target_list 1 library_target_directory)

        #----------------------------------------------------------------------#
        # Add the subdirectory
        #----------------------------------------------------------------------#

        add_subdirectory(${library_target_directory})

        #----------------------------------------------------------------------#
        #----------------------------------------------------------------------#

        cinch_make_include_links(${library_target_name}
            ${CMAKE_CURRENT_SOURCE_DIR}/${library_target_directory})

        #----------------------------------------------------------------------#
        # Set individual library includes for parent
        #
        # This allows users to select individual libraries from a submodule
        # without including the entire submodule.
        #----------------------------------------------------------------------#

        # DEPRECATED
        # This is deprecated by the above install links

        #if(NOT ${CMAKE_SOURCE_DIR} STREQUAL ${CMAKE_CURRENT_SOURCE_DIR})
        #    set(${library_target_name}_INCDIRS
        #        ${${library_target_name}_INCDIRS} PARENT_SCOPE)
        #endif(NOT ${CMAKE_SOURCE_DIR} STREQUAL ${CMAKE_CURRENT_SOURCE_DIR})

        #----------------------------------------------------------------------#
        # Add target includes to global include directories
        #
        # This adds the current library target includes to a global
        # include variable.
        #----------------------------------------------------------------------#

        # DEPRECATED
        # This is deprecated by the above install links

        #list(APPEND ${PROJECT_NAME}_INCDIRS ${${library_target_name}_INCDIRS})

        #----------------------------------------------------------------------#
        # Set individual library links for parent
        #
        # This allows users to select individual libraries from a submodule
        # without including the entire submodule.
        #----------------------------------------------------------------------#

        if(NOT ${CMAKE_SOURCE_DIR} STREQUAL ${CMAKE_CURRENT_SOURCE_DIR})
            set(${library_target_name}_LINKLIBS ${library_target_name}
                PARENT_SCOPE)
        endif(NOT ${CMAKE_SOURCE_DIR} STREQUAL ${CMAKE_CURRENT_SOURCE_DIR})

        #----------------------------------------------------------------------#
        # Add target to global link libraries
        #
        # This adds the current library target to the global link
        # libraries.
        #----------------------------------------------------------------------#

        list(APPEND ${PROJECT_NAME}_LINKLIBS ${library_target_name})

        #----------------------------------------------------------------------#
        # Generate info target
        #----------------------------------------------------------------------#

        cinch_make_info("${CINCH_CONFIG_INFOTAG}${library_target_name}"
            "${${library_target_name}_HEADERS}"
            "${${library_target_name}_SOURCES}")

        #----------------------------------------------------------------------#
        # Create relative paths for headers
        #----------------------------------------------------------------------#

        unset(relative_headers)
        foreach(header ${${library_target_name}_HEADERS})
            string(REGEX REPLACE
                "${CMAKE_CURRENT_SOURCE_DIR}/${library_target_directory}" ""
                relative_header ${header})
            list(APPEND relative_headers ${relative_header})
        endforeach(header)

        #----------------------------------------------------------------------#
        # Generate common header
        #----------------------------------------------------------------------#

        cinch_make_common_header("${library_target_name}" "${relative_headers}")

        #----------------------------------------------------------------------#
        # Add a rule to build the library
        #----------------------------------------------------------------------#

        if(NOT "${${library_target_name}_SOURCES}" STREQUAL "")
            add_library(${library_target_name}
                ${${library_target_name}_SOURCES})
        endif()

        #----------------------------------------------------------------------#
        # Add install targets
        #----------------------------------------------------------------------#

        if(NOT "${${library_target_name}_SOURCES}" STREQUAL "")
             install(TARGETS ${library_target_name} DESTINATION lib)
        endif()

        if(${library_target_name}_PUBLIC_HEADERS)
            foreach(file ${${library_target_name}_PUBLIC_HEADERS})
                install(FILES ${library_target_directory}/${file} DESTINATION
                    include/${library_target_name})
            endforeach(file ${${library_target_name}_PUBLIC_HEADERS})
        endif(${library_target_name}_PUBLIC_HEADERS)

        foreach(file ${relative_headers})
            get_filename_component(DIR ${file} DIRECTORY)
            install(FILES ${library_target_directory}/${file} DESTINATION
                include/${library_target_name}/${DIR})
        endforeach(file)

    endforeach(library_target)

    #--------------------------------------------------------------------------#
    # Set these for parent level build
    #--------------------------------------------------------------------------#

    if(NOT ${CMAKE_SOURCE_DIR} STREQUAL ${CMAKE_CURRENT_SOURCE_DIR})
        # DEPRECATED
        #set(${PROJECT_NAME}_INCDIRS ${${PROJECT_NAME}_INCDIRS} PARENT_SCOPE)
        set(${PROJECT_NAME}_LINKLIBS ${${PROJECT_NAME}_LINKLIBS} PARENT_SCOPE)
    else()
        set(CINCH_LINK_LIBRARIES ${${PROJECT_NAME}_LINKLIBS})
    endif(NOT ${CMAKE_SOURCE_DIR} STREQUAL ${CMAKE_CURRENT_SOURCE_DIR})


endif(CINCH_LIBRARY_TARGETS)

#------------------------------------------------------------------------------#
# Application directories
#------------------------------------------------------------------------------#

if(CINCH_APPLICATION_DIRECTORIES)
    foreach(application_directory ${CINCH_APPLICATION_DIRECTORIES})

        add_subdirectory(${application_directory})

    endforeach(application_directory)

endif(CINCH_APPLICATION_DIRECTORIES)

#------------------------------------------------------------------------------#
# Formatting options for emacs and vim.
# vim: set tabstop=4 shiftwidth=4 expandtab :
#------------------------------------------------------------------------------#
